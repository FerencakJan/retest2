<?phpuse Portal\Helpers\Resources\LocationsAllResource;if (!isset($ajax)) {    @include __DIR__ . "/../helpers/pageHelpers.php";}$propertyService = new Property($portal);if (isset($propertyId)) {    $property = $propertyService->findById($propertyId);} else {    $property = $propertyService->findById($portal->getPageData()['id']);}$globalListResource = new \Portal\Helpers\Resources\GlobalList('cz');$customerHelper = new CustomerHelper();$companyService = new Office($portal);$company = $companyService->byId($property['company_id']);$brokersService = new Brokers($portal);$broker = $brokersService->findByBrokerId($property['broker_id']);// vlastnosti$propertyProperties = $propertyService->findPropertiesForProperty($property['advert_id']);$propertiesArray = array();foreach ($propertyProperties as $propertyProperty) {    if (array_key_exists($propertyProperty['type_id'], $propertiesArray)) {        $propertiesArray[(int)$propertyProperty['type_id']][] = $propertyProperty['eu_id'];    } else {        $propertiesArray[(int)$propertyProperty['type_id']] = array($propertyProperty['eu_id']);    }}if (!(isset($data))) {    $data = $portal->getPageData()['getData'];}//print_r($data);$scoreEnable = true;if (isset($property['score']['disable']) && ($property['score']['disable'] + 0) === 1) {    $scoreEnable = false;}if (!$property) {    // redirect 404    echo '404';    die();}$scoreEnable = true;if (isset($property['score']['disable']) && ($property['score']['disable'] + 0) === 1) {  $scoreEnable = false;}//Ulo≈æenie posledn√©ho detailu (pred ak√Ωmkoƒævek HTML v√Ωstupom)require_once __DIR__ . '/../helpers/user_content.php';$ctx = getUserContext();$ctx['last_detail'] = [  'advert_type_eu'     => $property['advert_type_eu']     ?? null,  'advert_subtype_eu'  => $property['advert_subtype_eu']  ?? null,  'advert_function_eu' => $property['advert_function_eu'] ?? null,  'locality_latitude'  => $property['locality_latitude']  ?? null,  'locality_longitude' => $property['locality_longitude'] ?? null,  'locality_stat_kod'  => $property['locality_stat_kod']  ?? null,  'locality_kraj_kod'  => $property['locality_kraj_kod']  ?? null,  'locality_okres_kod' => $property['locality_okres_kod'] ?? null,  'locality_obec_kod'  => $property['locality_obec_kod']  ?? null,];saveUserContext($ctx);//print_r($property);$photos = unserialize($property['photos']);$videosUns = unserialize($property['videos']);$videos = [];$youtubeVideos = [];$matterport = [];foreach ($videosUns as $item) {    if (strpos($item['url'], 'youtube')) {        parse_str(parse_url($item['url'], PHP_URL_QUERY), $youtubeId);        $youtubeVideos[] = $youtubeId['v'];    } elseif (strpos($item['url'], 'youtu.be')) {        $youtubeId = ltrim(parse_url($item['url'], PHP_URL_PATH), '/');        $youtubeVideos[] = $youtubeId;    } elseif (strpos($item['url'], 'matterport')) {        $matterport[] = $item['url'];    } else {        $videos[] = $item['url'];    }}/*var_dump($videosUns);var_dump($videos);var_dump($youtubeVideos);var_dump($matterport);die();*/$betterPriceVariant = 1;//print_r($property);// vygeneruje veskere udaje do detailu@include __DIR__ . "/../pageComponents/detailFields.php";?><main class="main">    <?php if ($portal->renderRichSnippets()) { ?>        <?php $pageURL = LeadingSlash::checkLink((isset($_SERVER['HTTPS']) ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}{$property['alias_']}"); ?>        <div itemscope itemtype="http://schema.org/Accommodation http://schema.org/Product http://schema.org/Offer"            itemid="<?php echo $pageURL; ?>">            <link itemprop="additionalType" href="http://www.productontology.org/id/Real_estate">            <meta itemprop="category" content="Nemovitosti > Byty na prodej">            <meta itemprop="url" content="<?php echo $pageURL; ?>">            <?php            if ($property['advert_room_count'] > 0) {                echo "<meta itemprop=\"numberOfRooms\" content=\"{$property['advert_room_count']}\">";            } elseif ($property['advert_rooms_count'] > 0) {                echo "<meta itemprop=\"numberOfRooms\" content=\"{$property['advert_rooms_count']}\">";            }            ?>            <?php if ($property['usable_area'] > 0) { ?>                <meta itemprop="floorSize" content="<?php echo $property['usable_area']; ?>">            <?php } ?>            <?php            if (!($property['advert_price'] == 999999999 || $property['advert_price'] == 0)) {                echo "<meta itemprop=\"price\" content=\"{$property['advert_price']}\">";                echo '<meta itemprop="priceCurrency" content="Kƒç">';            }            ?>            <span itemprop="geo" itemscope itemtype="http://schema.org/GeoCoordinates">                <meta itemprop="latitude" content="<?php echo $property['locality_latitude']; ?>">                <meta itemprop="longitude" content="<?php echo $property['locality_longitude']; ?>">            </span>            <span itemprop="address" itemscope itemtype="http://schema.org/PostalAddress">                <?php if ($property['locality_street'] != '') { ?>                    <meta itemprop="streetAddress" content="<?php echo $property['locality_street']; ?>">                <?php } ?>                <?php if ($property['locality_city'] != '') { ?>                    <meta itemprop="addressLocality" content="<?php echo $property['locality_city']; ?>">                <?php } ?>                <?php                $fullList = new LocationsAllResource($portal->getLanguage());                $states = $fullList->getData();                if (isset($states['staty'][$property['locality_stat_kod']])) {                    $state = $states['staty'][$property['locality_stat_kod']]['nazev'];                    echo "<meta itemprop=\"addressRegion\" content=\"{$state}\">\n";                }                ?>                <meta itemprop="postalCode" content="<?php echo $property['locality_psc']; ?>">            </span>        <?php } else { ?>            <div>            <?php } ?>            <!--      --><?php //var_dump($data); die();                            ?>            <?php            @include __DIR__ . "/../pageComponents/breadcrumbs-gray.php";            ?>            <section class="detail-top">                <article class="container container--content" role="article">                    <div class="detail-top__overview">                        <?php if ($scoreEnable) { ?>                            <?php $starValue = ScoreFormatter::formate($property['score_avg']); ?>                            <?php                            @include __DIR__ . "/../pageComponents/rating.php";                            ?>                        <?php } ?>                        <?php                        @include __DIR__ . "/../pageComponents/dd-favourite.php";                        ?>                    </div>                    <h1 class="title title--lg detail-top__title"                        <?php if ($portal->renderRichSnippets()) { ?>itemprop="name" <?php } ?>>                        <a href="<?php if (isset($ajax)) {                                        echo '#';                                    } else {                                        echo '/';                                    } ?>" class="title__back"                            id="breadcrumbsBack">                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none"                                xmlns="http://www.w3.org/2000/svg">                                <path d="M18.64 8L20.52 9.88L14.4134 16L20.52 22.12L18.64 24L10.64 16L18.64 8Z"                                    fill="currentColor" />                            </svg>                        </a>                        <?php echo $property['title']; ?>                    </h1>                    <div class="detail-top__info">                        <h2 class="title title--top detail-top__subtitle"><?php                                                                            echo number_format($property['advert_price'], 0, ',', ' ');                                                                            if ($property['advert_price'] !== 'Info v RK') {                                                                                echo (' Kƒç');                                                                            }                                                                            ?>                          <small>                            <?php                            $price  = (float)($property['advert_price'] ?? 0);                            $area   = (float)($property['usable_area'] ?? 0);                            if ($area > 0) {                              $pricePerM2 = round($price / $area, 0);                              echo number_format($pricePerM2, 0, ',', ' ') . " Kƒç / m<sup>2</sup>";                            } else {                              echo "‚Äî Kƒç / m<sup>2</sup>"; // alebo nechaj pr√°zdne, podƒæa dizajnu                            }                            ?>                          </small>                        </h2>                        <?php if ($betterPriceVariant === 2) { ?>                            <a href="#modal" class="info js-modal-open"                                data-advert-id="<?php echo $property['advert_id']; ?>" data-price="<?php echo $price; ?>"                                data-z="<?php echo $property['advert_price']; ?>">                                <span class="icon icon--icon-info">                                    <svg class="icon__svg">                                        <use xlink:href="#icon-info"></use>                                    </svg>                                </span>                                Je mo≈æn√° lep≈°√≠ cena                            </a>                        <?php } ?>                    </div>                    <?php                    if ($property['advert_description'] && !empty($property['advert_description'])) {                        $advertDescription = unserialize($property['advert_description']);                        //var_dump($advertDescription);                    ?>                        <div class="badge-wrap badge-wrap--compact">                            <?php if ($property['energy_efficiency_rating_eu'] > 0) { ?>                                <p class="badge badge--rounded">                                    <!-- TODO: ratings: a-plus, b, c, d, e, f, g -->                                    <span class="badge__energy-efficiency" data-rating="g">G</span>                                    <?php echo $globalListResource->getByNameId($property['energy_efficiency_rating_eu']); ?>                                </p>                            <?php } ?>                            <?php                            foreach ($advertDescription as $keyAd => $valueAd) {                                echo '<span class="badge badge--rounded">' . $valueAd . '</span>';                            }                            ?>                        </div>                    <?php } ?>                    <div class="detail-top__action-menu">                        <div class="action-menu">                            <div class="action-menu__wrap">                                <a href="#agent">                                    <span class="icon icon--icon-phone">                                        <svg class="icon__svg">                                            <use xlink:href="#icon-phone"></use>                                        </svg>                                    </span>                                    Volat makl√©≈ôi                                </a>                                <a href="#inquiry">                                    <span class="icon icon--icon-message">                                        <svg class="icon__svg">                                            <use xlink:href="#icon-message"></use>                                        </svg>                                    </span>                                    Napsat makl√©≈ôi                                </a>                                <a href="#" onclick="window.print();">                                    <span class="icon icon--icon-print">                                        <svg class="icon__svg">                                            <use xlink:href="#icon-print"></use>                                        </svg>                                    </span>                                    Vytisknout inzer√°t                                </a>                            </div>                        </div>                        <?php if (isset($data['urlset']['fcb_group']) && strpos($data['urlset']['fcb_group'], 'https://') !== false) { ?>                            <?php                            @include __DIR__ . "/../pageComponents/join.php";                            ?>                        <?php } ?>                    </div>                </article>            </section>            <?php            @include __DIR__ . "/../pageComponents/gallery.php";            ?>            <section class="description">                <article class="container container--text" role="article">                    <div class="data">                        <div class="data__item data__item--highlight">                            <h4>Evidenƒçn√≠ ƒç√≠slo</h4>                            <p><strong><?php echo $property['advert_id']; ?></strong></p>                        </div>                        <?php if ($property['advert_subtype_eu'] > 0) { ?>                            <div class="data__item">                                <h4>Typ</h4>                                <p><strong>                                        <?php echo $globalListResource->getByNameId($property['advert_type_eu']); ?>,                                        <?php echo $globalListResource->getByNameId($property['advert_subtype_eu']); ?>                                        <?php echo $globalListResource->getByNameId($property['advert_function_eu']); ?>                                    </strong></p>                                <h4>Adresa</h4>                                <p><strong><?php echo $property['advert_locality']; ?></strong></p>                            </div>                        <?php } ?>                    </div>                    <div class="description__content">                        <h2 class="title title--compact description__title">Popis</h2>                        <p>                            <?php if ($property['description'] != '') {                                echo '<p temprop="description">' . $property['description'] . '</p>';                            } ?>                            <?php if ($property['description_add'] != '') {                                echo "<p>{$property['description_add']}</p>";                            } ?>                            <?php if ($property['title_en'] != '') {                                echo "<p><strong>{$property['title_en']}</strong></p>";                            } ?>                            <?php if ($property['description_en'] != '') {                                echo "<p>{$property['description_en']}</p>";                            } ?>                        </p>                    </div>                    <div class="description__properties">                        <div class="properties">                            <div class="properties__wrap">                                <p class="properties__more-less js-show-properties"><span>Zobrazit                                        v√≠ce</span><span>Zobrazit m√©nƒõ</span></p>                                <div class="properties__more">                                    <div class="properties__wrap-inside">                                        <?php                                        echo implode("", $arrBlockDetail);                                        ?>                                    </div>                                </div>                            </div>                        </div>                    </div>                    <?php //@include "../src/pageComponents/interested.php"                    ?>                    <div class="description__form" id="inquiry">                        <h3 class="title title--compact">M√°m dotaz k nemovitosti</h3>                        <form action="<?php echo $portal->formsTargetUrl(); ?>/mlift/services/save_form.php"                            method="post" class="async-form">                            <input name="form[form_type]" type="hidden" value="1">                            <div class="row row--form">                                <div class="col col--2">                                    <div class="form-item">                                        <label for="name">Jm√©no</label>                                        <input type="text" id="name" name="form[jmeno]">                                    </div>                                </div>                                <div class="col col--2">                                    <div class="form-item">                                        <label for="lastname">P≈ô√≠jmen√≠</label>                                        <input type="text" id="lastname" name="form[prijmeni]">                                    </div>                                </div>                                <div class="col col--2">                                    <div class="form-item">                                        <label for="email">Email</label>                                        <input type="email" id="email" name="form[email]">                                    </div>                                </div>                                <div class="col col--2">                                    <div class="form-item">                                        <label for="phone">Telefon</label>                                        <input type="tel" id="phone" name="form[telefon]">                                    </div>                                </div>                                <input type="hidden" class="input" name="form[advert_id][]"                                    value="[<?php echo $property['advert_id']; ?>]">                                <div class="col">                                    <div class="form-item">                                        <label for="message">Zpr√°va</label>                                        <textarea id="message" rows="6" name="form[dotaz]"                                            placeholder="Dobr√Ω den, zaujala mne tato nemovitost. Pros√≠m o poskytnut√≠ v√≠ce informac√≠ na uveden√©m telefonn√≠m ƒç√≠sle nebo e-mailov√© adrese. Dƒõkuji"><?php $lastQuestion = $customerHelper->getCustomerInfo(CustomerHelper::CUSTOMER_INFO_LAST_ANSWER);                                                                                                                                                                                                if ($lastQuestion != '') {                                                                                                                                                                                                    echo $lastQuestion;                                                                                                                                                                                                } ?></textarea>                                    </div>                                </div>                            </div>                            <div class="row row--form-bottom">                                <div class="col col--auto">                                    <div class="form-checkbox form-checkbox--inside">                                        <input type="checkbox" id="checkbox-gdpr" name="agree[personal_information]">                                        <span class="form-checkbox__box"></span>                                        <label class="form-label" for="checkbox-gdpr">Souhlas√≠m s ochranou osobn√≠ch                                            √∫daj≈Ø</label>                                    </div>                                </div>                                <div class="col col--auto">                                    <div class="form-checkbox form-checkbox--inside">                                        <input type="checkbox" name="agree[newsletter]" id="checkbox-newsletter">                                        <span class="form-checkbox__box"></span>                                        <label class="form-label" for="checkbox-newsletter">Souhlas se zas√≠l√°n√≠m                                            obchodn√≠ch sdƒõlen√≠</label>                                    </div>                                </div>                                <div class="col col--auto col--submit">                                    <button class="btn btn--md" type="submit">Odeslat dotaz</button>                                </div>                            </div>                        </form>                    </div>                    <div class="description__agent" id="agent">                        <?php                        @include __DIR__ . "/../pageComponents/agent.php";                        ?>                    </div>                </article>            </section>            <script>                <?php                $geoJson = new GeoJson();                $geoJson->addPoint(                    $property['locality_latitude'],                    $property['locality_longitude'],                    array(                        'advert_id' => $property['advert_id'],                        'show_marker' => !$property['do_not_show_marker'],                        'image' => $photos[0],                        'textTop' => htmlspecialchars(preg_replace('/\s+/', ' ', $property['title']), ENT_QUOTES, 'UTF-8'),                        'textBottom' => $property['advert_price'] == 999999999 || $property['advert_price'] === 0 ?                            'Info v RK' :                            number_format($property['advert_price'], 0, ' ', ' ') . ' ' . $globalListResource->getByNameId($property['advert_price_unit_eu'])                    )                );                ?>                function getMarkers() {                    return JSON.parse(<?php echo $geoJson->getHtml(); ?>);                }            </script>            <section class="around">                <article class="container container--content" role="article">                    <h2 class="title title--content next__title">Na≈°e nab√≠dka nemovitost√≠</h2>                    <div class="around__map">                        <div class="map-wrap">                            <div id="js-map"></div>                        </div>                    </div>                </article>            </section>            <?php            @include __DIR__ . "/../pageComponents/next.php";            @include __DIR__ . "/../pageComponents/back.php";            ?>              <script>                (function attachSatZoomButton(){                  // --- CSS pre 30√ó30 tlaƒçidlo v zoom bloku ---                  if (!document.getElementById('zoom-sat-css')) {                    var st = document.createElement('style');                    st.id = 'zoom-sat-css';                    st.textContent = `      .leaflet-control{z-index:9999!important}      .leaflet-control-zoom a.zoom-sat{        width:30px;height:30px;line-height:30px;display:block;        text-align:center;background:#fff;color:#000;cursor:pointer;      }      .leaflet-control-zoom a.zoom-sat:hover{background:#f4f4f4}      .leaflet-control-zoom a.zoom-sat.is-on{background:#e9ecef}      .leaflet-control-zoom a.zoom-sat svg{vertical-align:middle}      /* prilepenie k m√≠nus bez medzery */      .leaflet-control-zoom a.leaflet-control-zoom-out{border-bottom-left-radius:0;border-bottom-right-radius:0}      .leaflet-control-zoom a.zoom-sat{border-top-left-radius:0;border-top-right-radius:0}    `;                    document.head.appendChild(st);                  }                  function buildSatelliteLayer(){                    return L.tileLayer(                      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',                      { attribution:'Tiles ¬© Esri ‚Äî Earthstar Geographics', maxZoom:20 }                    );                  }                  function findBaseLayer(map){                    var base = null;                    map.eachLayer(function(l){ if (!base && l instanceof L.TileLayer) base = l; });                    if (!base) {                      base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',                        { attribution:'¬© OpenStreetMap', maxZoom:19 }).addTo(map);                    }                    return base;                  }                  function ensureZoomControl(map){                    // ak zoom control neexistuje, prid√°me ho                    var zoomCtl = map._controlContainer && map._controlContainer.querySelector('.leaflet-control-zoom.leaflet-bar');                    if (!zoomCtl) {                      L.control.zoom({position:'topleft'}).addTo(map);                      zoomCtl = map._controlContainer && map._controlContainer.querySelector('.leaflet-control-zoom.leaflet-bar');                    }                    return zoomCtl;                  }                  function addButton(map){                    if (map.__satZoomBtnAttached) return true;                    var zoomCtl = ensureZoomControl(map);                    if (!zoomCtl) return false; // e≈°te nie je v DOM ‚Äì sk√∫sime nesk√¥r                    // priprav vrstvy                    var satellite = map.__satLayer || buildSatelliteLayer();                    map.__satLayer = satellite;                    map.__baseLayer = findBaseLayer(map);                    // u≈æ existuje?                    if (zoomCtl.querySelector('.zoom-sat')) { map.__satZoomBtnAttached = true; return true; }                    // vytvor tlaƒçidlo                    var btn = document.createElement('a');                    btn.className = 'zoom-sat';                    btn.href = '#';                    btn.title = 'Leteck√Ω / mapa';                    // ikonka (kƒæudne nahraƒè za üõ∞Ô∏è)                    btn.innerHTML = 'üõ∞Ô∏è';                    // vlo≈æ priamo POD m√≠nus                    var zoomOut = zoomCtl.querySelector('.leaflet-control-zoom-out');                    if (zoomOut && zoomOut.nextSibling) {                      zoomCtl.insertBefore(btn, zoomOut.nextSibling);                    } else {                      zoomCtl.appendChild(btn);                    }                    L.DomEvent.disableClickPropagation(btn);                    L.DomEvent.on(btn,'click',function(e){                      L.DomEvent.preventDefault(e);                      var on = map.hasLayer(satellite);                      // pre istotu si v≈ædy over√≠me aktu√°lny base (ak si ho inde men√≠≈°)                      map.eachLayer(function(l){ if (l instanceof L.TileLayer && l !== satellite) map.__baseLayer = l; });                      if (on) {                        map.removeLayer(satellite);                        if (!map.hasLayer(map.__baseLayer)) map.__baseLayer.addTo(map);                        btn.classList.remove('is-on');                      } else {                        if (map.hasLayer(map.__baseLayer)) map.removeLayer(map.__baseLayer);                        satellite.addTo(map);                        btn.classList.add('is-on');                      }                    });                    map.__satZoomBtnAttached = true;                    return true;                  }                  function tryAttach(){                    var map = window.mapboxMap;                    if (!map || typeof L === 'undefined') return false;                    if (addButton(map)) return true;                    // ak zoom control e≈°te nebol v DOM, sleduj jeho objavenie                    var container = map._controlContainer || document;                    var mo = new MutationObserver(function(){                      if (addButton(map)) mo.disconnect();                    });                    mo.observe(container, {childList:true, subtree:true});                    return true;                  }                  // ƒçakaj na mapu ‚Äì istota aj pri neskorom loade                  var attempts = 0, iv = setInterval(function(){                    if (tryAttach() || ++attempts > 100) clearInterval(iv); // a≈æ ~10s                  }, 100);                })();              </script></main><?php echo "<section class=\"box-seo\">{$data['html']['text']}</section>"; ?><?phpif (!isset($ajax)) {    @include __DIR__ . "/../pageComponents/footer.php";}?>