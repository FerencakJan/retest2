<?php@include "../src/helpers/pageHelpers.php";require_once __DIR__ . "/../pageComponents/advert/listingAdvert.php";// ADDED: kontext (session+cookies)require_once __DIR__ . '/../helpers/user_content.php';$ctx = getUserContext();$propertyRepo = new Property($portal);if (!$data){  $data = $portal->getPageData() ?? null;}$pageData = $portal->getPageData();$page = solvePageNumber();$customerHelper = new CustomerHelper();$globalListResource = new \Portal\Helpers\Resources\GlobalList('cz');$searchParam = isset($_POST['search']) ? filter_var($_POST['search'], FILTER_SANITIZE_STRING) : null;if($page > 1){  $portal->setMetaRobots(false, true);}$propertiesOffset = ($page * Constants::DEFAULT_LISTING_COUNT) - Constants::DEFAULT_LISTING_COUNT;$propertiesQueryResult = null;/* ---------- helpers na str√°≈æiace doplnenie kontextu a cleanup ---------- */function hasAnyLocationFilter(array $q): bool {  return isset($q['locality_latitude'], $q['locality_longitude'])    || isset($q['locality_stat_kod'])    || isset($q['locality_kraj_kod'])    || isset($q['locality_okres_kod'])    || isset($q['locality_obec_kod']);}function hasAnyTypeFilter(array $q): bool {  return !empty($q['advert_type_eu']) || !empty($q['advert_subtype_eu']) || !empty($q['advert_function_eu']);}function cleanupInFilters(array &$q): void {  // odstr√°≈à pr√°zdne IN filtre  foreach (['advert_type_eu','advert_subtype_eu','advert_function_eu'] as $k) {    if (!array_key_exists($k, $q)) continue;    if (is_array($q[$k])) {      $vals = array_values(array_filter($q[$k], function($v){        if (is_string($v)) $v = trim($v);        if ($v === '' || $v === null) return false;        if (is_string($v) && !ctype_digit($v)) return false;        return true;      }));      if (!$vals) unset($q[$k]);      else $q[$k] = array_map('intval', $vals);    } else {      if ($q[$k] === '' || $q[$k] === null) unset($q[$k]);      else $q[$k] = (int)$q[$k];    }  }  // lokalitn√© k√≥dy ‚Äì necpeme pr√°zdne rovnosti  foreach (['locality_stat_kod','locality_kraj_kod','locality_okres_kod','locality_obec_kod'] as $k) {    if (isset($q[$k]) && ($q[$k] === '' || $q[$k] === null)) unset($q[$k]);  }}/* ---------------------------------------------------------------------- */if($pageData['action'] === 'searchform') {  if(!LastQuerySession::haveLastQuery()) {    $queryData = $pageData['getData']['sql'];    if (!isset($queryData['company_country_id'])) {      $queryData['company_country_id'] = $portal->getPortalCountryId();    }    if ((int)$pageData['portalInfo']['company_type'] === 0) {      $queryData['advert_status_eu'] = array(51,52);    }    if ((int)$pageData['portalInfo']['company_type'] === 1) {      $queryData['advert_status_eu'] = array(51,251,52,548);    }    // ‚úÖ aplikuj kontext LEN keƒè nie s√∫ ≈æiadne typov√© ani lokalitn√© filtre    if (!hasAnyLocationFilter($queryData) && !hasAnyTypeFilter($queryData)) {      $queryData = mergeContextIntoQuery($queryData, $ctx);    }    // ‚úÖ cleanup ‚Äì zabr√°≈à pr√°zdnym IN ()    cleanupInFilters($queryData);    $propertiesQueryResult = $propertyRepo->search(      $queryData,      $propertiesOffset,      Constants::LISTING_PROPERTIES_COUNT,      $customerHelper->getListingSort()    );    LastQuerySession::saveLastQuery(      $propertiesQueryResult['fullQuery'],      $propertiesQueryResult['params'],      $queryData,      $pageData['getData']['urlset']['lister_url']    );  } else {    $queryData = LastQuerySession::getLastQueryData();    $propertiesQueryResult = $propertyRepo->searchBySolved(      LastQuerySession::getLastFullQuery(),      LastQuerySession::getLastQueryParams(),      $propertiesOffset,      Constants::LISTING_PROPERTIES_COUNT,      $customerHelper->getListingSort()    );  }}else{  $queryData = $pageData['getData']['sql'];  if (!isset($queryData['company_country_id'])) {    $queryData['company_country_id'] = $portal->getPortalCountryId();  }  if ($portal->getPortalCompanyType() == 0) {    $queryData['advert_status_eu'] = array(51,52);  }  if ($portal->getPortalCompanyType() == 1) {    $queryData['advert_status_eu'] = array(51,251,52,548);  }  // ‚úÖ aplikuj kontext LEN keƒè nie s√∫ ≈æiadne typov√© ani lokalitn√© filtre  if (!hasAnyLocationFilter($queryData) && !hasAnyTypeFilter($queryData)) {    $queryData = mergeContextIntoQuery($queryData, $ctx);  }  // ‚úÖ cleanup ‚Äì zabr√°≈à pr√°zdnym IN ()  cleanupInFilters($queryData);  $propertiesQueryResult = $propertyRepo->search(    $queryData,    $propertiesOffset,    Constants::LISTING_PROPERTIES_COUNT,    $customerHelper->getListingSort()  );  LastQuerySession::saveLastQuery(    $propertiesQueryResult['fullQuery'],    $propertiesQueryResult['params'],    $queryData,    $pageData['getData']['urlset']['lister_url']  );}$formData = LastQuerySession::haveLastQuery()? LastQuerySession::getLastQueryData() : $pageData['getData']['sql'];$maxPage = ceil($propertiesQueryResult['totalSum'] / Constants::DEFAULT_LISTING_COUNT);// Ulo≈æenie posledn√Ωch 2‚Äì3 hƒæadan√≠ do session/cookiesrequire_once __DIR__ . '/../helpers/user_content.php';$ctx = getUserContext();// queryData v tomto mieste obsahuje aktu√°lne pou≈æit√© filtre$searchItem = [  'advert_type_eu'     => $queryData['advert_type_eu']     ?? null,  'advert_subtype_eu'  => $queryData['advert_subtype_eu']  ?? null,  'advert_function_eu' => $queryData['advert_function_eu'] ?? null,  'locality_latitude'  => $queryData['locality_latitude']  ?? null,  'locality_longitude' => $queryData['locality_longitude'] ?? null,  'locality_stat_kod'  => $queryData['locality_stat_kod']  ?? null,  'locality_kraj_kod'  => $queryData['locality_kraj_kod']  ?? null,  'locality_okres_kod' => $queryData['locality_okres_kod'] ?? null,  'locality_obec_kod'  => $queryData['locality_obec_kod']  ?? null,  // dr≈æ kƒæ√∫ƒçe price_from/price_to (filter.php ich mapuje na advert_price_min/max)  'price_from'         => $queryData['price_from']         ?? ($queryData['advert_price_min'] ?? null),  'price_to'           => $queryData['price_to']           ?? ($queryData['advert_price_max'] ?? null),  'area_from'          => $queryData['area_from'] ?? null,  'area_to'            => $queryData['area_to']   ?? null,  'rooms'              => $queryData['rooms']     ?? null,  'ts' => time(),];// zap√≠≈° iba ak pou≈æ√≠vateƒæ re√°lne nieƒço hƒæadal (aspo≈à 1 pole m√° hodnotu)$hasAny = false;foreach ($searchItem as $k => $v) {  if ($k === 'ts') continue;  if ($v !== null && $v !== '' && $v !== '0') { $hasAny = true; break; }}if ($hasAny) {  if (!isset($ctx['recent_searches']) || !is_array($ctx['recent_searches'])) {    $ctx['recent_searches'] = [];  }  $ctx['recent_searches'][] = $searchItem;  $ctx['recent_searches'] = array_values(array_slice($ctx['recent_searches'], -3));  saveUserContext($ctx); // nastav√≠ session aj cookies}$scoreEnable = true;if(isset($data['score']['disable']) && ($data['score']['disable']+0) === 1){  $scoreEnable = false;}?><?php  $listingSort = $customerHelper->getListingSort();?><main class="main" id="mainListing">    <?php @include "../src/pageComponents/filter.php" ?>    <section class="listing listing--filter">        <article class="container container--xlg" role="article">            <div class="listing__wrap">                <div class="listing__content">                    <div class="listing__top">                        <div class="listing__top-col">                            <?php if ($scoreEnable) { ?>                            <?php @include "../src/pageComponents/rating.php" ?>                            <?php } ?>                        </div>                    </div>                    <div class="listing__heading">                        <h1 class="title listing__title">                            <?php if ($propertiesQueryResult['totalSum'] > 0) { ?>                            <strong>                                <?php                            $totalSum = $propertiesQueryResult['totalSum'];                            if ($totalSum == 1){                            echo $totalSum; ?> v√Ωsledek vyhled√°v√°n√≠                                <?php } elseif ($totalSum > 1 && $totalSum < 5) {                            echo $totalSum; ?> v√Ωsledky vyhled√°v√°n√≠                                <?php } else {                              echo $totalSum; ?> v√Ωsledk≈Ø vyhled√°v√°n√≠                                <?php } ?>                            </strong>                        </h1>                        <?php } else { ?>                        <p>Je n√°m l√≠to, ale zvolen√Ωm krit√©ri≈Øm neodpov√≠d√° <strong>≈æ√°dn√° nab√≠dka</strong></p>                        <?php } ?>                    </div>                    <?php @include "../src/pageComponents/location-filter.php" ?>                    <div class="listing__top">                        <div class="listing__top-col">                            <a href="#search-advanced" class="btn btn--secondary btn--sm js-modal-open">Ulo≈æit jako                                popt√°vku</a>                            <?php if(isset($data['urlset']['fcb_group']) && strpos($data['urlset']['fcb_group'], 'https://') !== false){ ?>                            <?php @include "../src/pageComponents/join-sm.php" ?>                            <?php } ?>                        </div>                        <div class="listing__top-col">                            <a href="#search-advanced" class="btn btn--clear btn--rounded-0 js-modal-open">                                <span>Filtr</span>                                <span class="icon icon--icon-filter">                                    <svg class="icon__svg">                                        <use xlink:href="#icon-filter"></use>                                    </svg>                                </span>                            </a>                            <div class="location-filter__select">                                <div class="custom-select custom-select--filter">                                    <select class="cookie-save-input-value" name="listing-sort" id="filter2">                                        <option value="sort-default"                                            <?php if ($listingSort == 'sort-default'){ echo 'selected'; } ?>>V√Ωchoz√≠                                            ≈ôazen√≠</option>                                        <option value="sort-price"                                            <?php if ($listingSort == 'sort-price'){ echo 'selected'; } ?>>Cena od                                            nejlevnƒõj≈°√≠</option>                                        <option value="sort-price-max"                                            <?php if ($listingSort == 'sort-price-max'){ echo 'selected'; } ?>>Cena od                                            nejdra≈æ≈°√≠</option>                                        <option value="sort-added"                                            <?php if ($listingSort == 'sort-added'){ echo 'selected'; } ?>>Nejnovƒõj≈°√≠                                        </option>                                        <option value="sort-added-max"                                            <?php if ($listingSort == 'sort-added-max'){ echo 'selected'; } ?>>Nejstar≈°√≠                                        </option>                                    </select>                                </div>                            </div>                        </div>                    </div>                    <div class="listing__grid">                        <?php                        $count = 0;                        if(null !== $propertiesQueryResult) {                         $count = count($propertiesQueryResult['rows']);                          foreach ($propertiesQueryResult['rows'] as $property) {                            echo renderListingAdvert($portal, $property);                          }                        }                      ?>                    </div>                    <?php                  /*                   * LISTER                   */                  if($propertiesQueryResult['totalSum'] > Constants::DEFAULT_LISTING_COUNT)                  {                  $baseUrl = $_SERVER['REDIRECT_URL'];                  $posPage = strpos($baseUrl, '/page-');                  if($posPage !== false){                  $baseUrl = substr($baseUrl, 0, $posPage);                  }                  $pager = new Pager($baseUrl,$baseUrl, $maxPage, $page, $searchParam != null? array('search' => $_GET['search']) : array());                  echo $pager->render(true);                  }                  ?>                    <?php if (isSet($data['html']['text'])) { ?>                    <div class="listing__additional">                        <div class="read-more" data-height="200">                            <?php  echo "<section class=\"box-seo\">{$data['html']['text']}</section>"; ?>                        </div>                        <div class="line">                            <button class="btn btn--sm btn--nofocus line__after read-more__btn js-read-more"><span>ƒå√≠st                                    d√°le</span><span>Zobrazit m√©nƒõ</span></button>                        </div>                    </div>                    <?php } ?>                </div>                <div class="listing__map">                  <script>                    <?php                    $geoJson = new GeoJson();                    foreach ($propertiesQueryResult['rows'] as $mapProperty) {                      $geoJson->addPoint(                        $mapProperty['locality_latitude'],                        $mapProperty['locality_longitude'],                        array(                          'advert_id' => $mapProperty['advert_id'],                          'image' => $mapProperty['photo'],                          'link' => $mapProperty['alias_'],                          'textTop' => htmlspecialchars(preg_replace('/\s+/', ' ',$mapProperty['title']), ENT_QUOTES, 'UTF-8'),                          'textBottom' => $mapProperty['advert_price'] == 999999999 || $mapProperty['advert_price'] === 0?                            'Info v RK' :                            number_format($mapProperty['advert_price'],0, ' ', ' ') . ' ' . $globalListResource->getByNameId($mapProperty['advert_price_unit_eu'])));                    }                    ?>                    function getMarkers() {                      return JSON.parse(<?php echo $geoJson->getHtml(); ?>);                    }                  </script>                    <div class="map-wrap">                        <div id="js-map"></div>                    </div>                </div>            </div>        </article>    </section>  <script>    /*      Satelitn√Ω prep√≠naƒç priamo v zoom bloku (30√ó30), nalepen√Ω pod "‚Äì".      Funguje na tom istom princ√≠pe ako na √∫vodnej str√°nke.    */    (function attachSatZoomButton(){      // 1) CSS (len raz)      if (!document.getElementById('zoom-sat-css')) {        var st = document.createElement('style');        st.id = 'zoom-sat-css';        st.textContent = `      .leaflet-control{z-index:9999!important}      .leaflet-control-zoom a.zoom-sat{        width:30px;height:30px;line-height:30px;display:block;        text-align:center;background:#fff;color:#000;cursor:pointer;        user-select:none;      }      .leaflet-control-zoom a.zoom-sat:hover{background:#f4f4f4}      .leaflet-control-zoom a.zoom-sat.is-on{background:#e9ecef}      .leaflet-control-zoom a.zoom-sat svg{vertical-align:middle}      /* prilepenie k m√≠nus bez medzery */      .leaflet-control-zoom a.leaflet-control-zoom-out{border-bottom-left-radius:0;border-bottom-right-radius:0}      .leaflet-control-zoom a.zoom-sat{border-top-left-radius:0;border-top-right-radius:0}    `;        document.head.appendChild(st);      }      function buildSatelliteLayer(){        return L.tileLayer(          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',          { attribution:'Tiles ¬© Esri ‚Äî Earthstar Geographics', maxZoom:20 }        );      }      function findBaseLayer(map){        var base = null;        map.eachLayer(function(l){ if (!base && l instanceof L.TileLayer) base = l; });        if (!base) {          base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',            { attribution:'¬© OpenStreetMap', maxZoom:19 }).addTo(map);        }        return base;      }      function ensureZoomControl(map){        var zoomCtl = map._controlContainer && map._controlContainer.querySelector('.leaflet-control-zoom.leaflet-bar');        if (!zoomCtl) {          L.control.zoom({position:'topleft'}).addTo(map);          zoomCtl = map._controlContainer && map._controlContainer.querySelector('.leaflet-control-zoom.leaflet-bar');        }        return zoomCtl;      }      function addButton(map){        if (!map) return false;        if (map.__satZoomBtnAttached) return true;        var zoomCtl = ensureZoomControl(map);        if (!zoomCtl) return false; // e≈°te nie je v DOM        // vrstvy        var satellite = map.__satLayer || buildSatelliteLayer();        map.__satLayer = satellite;        map.__baseLayer = findBaseLayer(map);        // u≈æ existuje?        if (zoomCtl.querySelector('.zoom-sat')) { map.__satZoomBtnAttached = true; return true; }        // tlaƒçidlo        var btn = document.createElement('a');        btn.className = 'zoom-sat';        btn.href = '#';        btn.title = 'Leteck√Ω / mapa';        btn.setAttribute('aria-label','Leteck√Ω / mapa');        btn.textContent = 'üõ∞Ô∏è';        // vlo≈æ POD m√≠nus        var zoomOut = zoomCtl.querySelector('.leaflet-control-zoom-out');        if (zoomOut && zoomOut.nextSibling) {          zoomCtl.insertBefore(btn, zoomOut.nextSibling);        } else {          zoomCtl.appendChild(btn);        }        L.DomEvent.disableClickPropagation(btn);        L.DomEvent.on(btn,'click',function(e){          L.DomEvent.preventDefault(e);          var on = map.hasLayer(satellite);          // istota: aktualizuj referenciu na base, ak by sa zmenila          map.eachLayer(function(l){ if (l instanceof L.TileLayer && l !== satellite) map.__baseLayer = l; });          if (on) {            map.removeLayer(satellite);            if (!map.hasLayer(map.__baseLayer)) map.__baseLayer.addTo(map);            btn.classList.remove('is-on');          } else {            if (map.hasLayer(map.__baseLayer)) map.removeLayer(map.__baseLayer);            satellite.addTo(map);            btn.classList.add('is-on');          }        });        map.__satZoomBtnAttached = true;        return true;      }      function tryAttach(){        var map = window.mapboxMap; // tvoja Leaflet mapa je ukladan√° sem        if (!map || typeof L === 'undefined') return false;        if (addButton(map)) return true;        // ak zoom control e≈°te nie je v DOM, sleduj jeho objavenie        var container = map._controlContainer || document;        var mo = new MutationObserver(function(){          if (addButton(map)) mo.disconnect();        });        mo.observe(container, {childList:true, subtree:true});        return true;      }      // pokusy (kv√¥li tomu, ≈æe mapa vznik√° a≈æ po initOpenStreetMap)      var attempts = 0, iv = setInterval(function(){        if (tryAttach() || ++attempts > 100) clearInterval(iv);      }, 100);      // keƒè pr√≠de navig√°cia cez hist√≥riu (SPA/partial), sk√∫s znova      window.addEventListener('pageshow', function(){ setTimeout(tryAttach, 200); }, {once:true});    })();  </script></main><?php @include "../src/pageComponents/footer.php" ?>