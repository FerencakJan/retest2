/* ==============================   16-openstreetmap.js — Leaflet only (geo cookies + fallback + layers switch)   ============================== */// ---- Cookie helpersfunction setCookie(name, value, days) {  var expires = "";  if (days) {    var d = new Date();    d.setTime(d.getTime() + days*24*60*60*1000);    expires = "; expires=" + d.toUTCString();  }  document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/; SameSite=Lax";}function getCookie(name) {  var nameEQ = name + "=";  var ca = document.cookie.split(";");  for (var i=0;i<ca.length;i++){    var c = ca[i].trim();    if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length));  }  return null;}// ---- Geo (promise)function requestBrowserGeo() {  return new Promise(function(resolve, reject){    if (!navigator.geolocation) return reject(new Error("no-geo"));    navigator.geolocation.getCurrentPosition(function(pos){      resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });    }, function(err){      reject(err || new Error("geo-denied"));    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 });  });}// Poistka proti dvojitej initif (!window.__leaflet_map_inited__) {  window.__leaflet_map_inited__ = false;}function initMapBox() {  var listingMap = document.getElementById("js-map");  if (window.__leaflet_map_inited__) return;  if (listingMap && typeof window.getMarkers !== "undefined") {    initOpenStreetMap(listingMap);  }}function createMarkerElement(accommodationId, selected, showMarker) {  var iconHtml = `    <div class="icon-property">      <img src="${files}img/property-ostatni.svg" width="20" height="20" />    </div>  `;  return L.divIcon({    html: iconHtml,    iconSize: [36, 36],    iconAnchor: [17, 36],    popupAnchor: [0, -36],    className: ""  });}function removeSelectedMaker() {  var icons = document.getElementsByClassName("leaflet-marker-icon");  for (var i = 0; i < icons.length; i++) {    if (icons.hasOwnProperty(i)) {      if (typeof icons[i].src != "undefined" && icons[i].src.indexOf("special") !== -1) {        icons[i].src = files + "images/map-point-special.png";      } else {        icons[i].src = files + "images/map-point.png";      }    }  }}function restoreMapSettings() {  if (typeof window.mapBoxSettingsSave == "object") {    window.mapboxMode = "listing";    window.mapboxMap.flyTo(      window.mapBoxSettingsSave.center,      window.mapBoxSettingsSave.zoom    );  }}function initOpenStreetMap(element) {  if (window.__leaflet_map_inited__) return; // poistka  window.__leaflet_map_inited__ = true;  // resize fix pri prepínaní layoutu  var pv = document.getElementById("js-page-view");  if (pv) {    var links = pv.querySelectorAll("a");    for (var i = 0; i < links.length; i++) {      if (links.hasOwnProperty(i)) {        links[i].addEventListener("click", function () {          setTimeout(function () {            window.dispatchEvent(new Event("resize"));          }, 500);        });      }    }  }  var features = (window.getMarkers && window.getMarkers()["features"]) || [];  // --- Defaults ---  var DEFAULT_CENTER = [50.0755, 14.4378]; // Praha  var DEFAULT_ZOOM = 12;  // preferuj GEO cookie  var savedAllowed = getCookie("geo_allowed") === "1";  var savedLat = parseFloat(getCookie("geo_lat"));  var savedLng = parseFloat(getCookie("geo_lng"));  if (savedAllowed && isFinite(savedLat) && isFinite(savedLng)) {    DEFAULT_CENTER = [savedLat, savedLng];    DEFAULT_ZOOM = 12;  }  // Mapa  var map = L.map(element.id).setView(DEFAULT_CENTER, DEFAULT_ZOOM);  var originalClosePopup = map.closePopup.bind(map);  map.closePopup = function () {    // nechceme, aby sa popup zavíral pri mouseout z markeru / mapy    // ak by sme ho niekedy potrebovali zavrieť ručne, použijeme originalClosePopup()  };  // --- Mapové podklady (base layers) ---  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {    attribution: '&copy; OpenStreetMap contributors',    maxZoom: 19,    subdomains: 'abc'  });  const esriSat = L.tileLayer(    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',    {      attribution: 'Imagery &copy; Esri, Maxar, Earthstar Geographics',      maxZoom: 19    }  );  // voliteľné popisky pre leteckú vrstvu  const labels = L.tileLayer(    'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',    {      attribution: '&copy; CARTO',      maxZoom: 19,      subdomains: 'abcd',      pane: 'overlayPane'    }  );  // predvolená vrstva  osm.addTo(map);  // prepínač vrstiev  const baseLayers = {    'Mapa': osm,    'Letecká': esriSat,    'Letecká + popisky': L.layerGroup([esriSat, labels])  };  L.control.layers(baseLayers, null, {    position: 'topright',    collapsed: false  }).addTo(map);  window.mapboxMap = map;  window.mapboxMode = element.getAttribute("data-mode") ? element.getAttribute("data-mode") : "listing";  var markersGroup = L.markerClusterGroup({    iconCreateFunction: function (cluster) {      var childCount = cluster.getChildCount();      return new L.DivIcon({        html: "<div><span>" + childCount + "</span></div>",        className: "marker-cluster",        iconSize: new L.Point(40, 40)      });    }  });  window.solvedMarkers = [];  var bounds = null;  for (var i = 0; i < features.length; i++) {    var f = features[i];    var lon = f && f.geometry && f.geometry.coordinates ? f.geometry.coordinates[0] : null;    var lat = f && f.geometry && f.geometry.coordinates ? f.geometry.coordinates[1] : null;    if (isFinite(lon) && isFinite(lat) && Math.abs(lon) <= 180 && Math.abs(lat) <= 90) {      var latlng = L.latLng(lat, lon);      bounds = bounds ? bounds.extend(latlng) : L.latLngBounds(latlng, latlng);      var marker = L.marker([lat, lon], {        icon: createMarkerElement(          f.properties && f.properties.advert_id,          features.length !== 1,          f.properties && f.properties.show_marker        )      });      marker.advert_id = f.properties && f.properties.advert_id;      if (features.length > 1) {        var hasLink = f.properties && f.properties.link && f.properties.link.length > 0;        var html =          '<div class="estate estate--simple">' +          // ak je link, obalíme LEN obrázok          (hasLink ? '<a href="' + f.properties.link + '" class="estate__image-link">' : '') +          '<div class="estate__image">' +          '<img loading="lazy" src="' + (f.properties.image || '') + '" alt="">' +          '</div>' +          (hasLink ? '</a>' : '') +          '<div class="estate__content">' +          '<h3 class="title title--sm estate__title">' + (f.properties.textTop || '') + '</h3>' +          '<p class="title title--next estate__price"><small>' + (f.properties.textBottom || '') + '</small></p>' +          '</div>' +          '</div>';        marker.bindPopup(html, {          autoClose: false,          closeOnClick: false        });        // PRE ISTOTU: zruš všetky existujúce hover handlery        marker.off('mouseover');        marker.off('mouseout');        // otvor popup len pri hoveri na marker        marker.on('mouseover', function () {          this.openPopup();        });      }      marker.addEventListener("click", function (e) {        if (window.mapboxMode === "listing") {          window.mapBoxSettingsSave = {            center: window.mapboxMap.getCenter(),            zoom: window.mapboxMap.getZoom()          };        }        window.mapboxMap.flyTo(e.latlng, 17);      });      window.solvedMarkers.push(marker);      markersGroup.addLayer(marker);    }  }  map.addLayer(markersGroup);  // Centrovanie/fallbacky  var layerCount = markersGroup.getLayers().length;  if (layerCount > 1) {    var groupBounds = markersGroup.getBounds();    if (groupBounds && groupBounds.isValid && groupBounds.isValid()) {      map.fitBounds(groupBounds, { padding: [30, 30], maxZoom: 14 });    } else {      map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);    }  } else if (layerCount === 1) {    var only = markersGroup.getLayers()[0];    if (only && only.getLatLng) {      map.setView(only.getLatLng(), 16);    } else {      map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);    }  } else {    // žiadne markery → jednorazovo skús geolokáciu    var alreadyPrompted = getCookie("geo_prompted") === "1";    if (!savedAllowed && !alreadyPrompted) {      setCookie("geo_prompted", "1", 30);      requestBrowserGeo()        .then(function(pos){          setCookie("geo_allowed","1",365);          setCookie("geo_lat", String(pos.lat), 365);          setCookie("geo_lng", String(pos.lng), 365);          map.setView([pos.lat, pos.lng], 14);        })        .catch(function(){          setCookie("geo_allowed","0",365);          map.setView(DEFAULT_CENTER, 14);        });    } else {      map.setView(DEFAULT_CENTER, 14);    }  }}